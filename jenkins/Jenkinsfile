pipeline {
    agent any

    environment {
        AWS_ACCESS_KEY_ID = credentials('aws-access-key-id')     // Jenkins credential ID
        AWS_SECRET_ACCESS_KEY = credentials('aws-secret-key-id') // Jenkins credential ID
        AWS_DEFAULT_REGION = 'ap-south-1'
    }

    stages {
        stage('Checkout') {
            steps {
                checkout([$class: 'GitSCM',
                    branches: [[name: '*/main']],
                    userRemoteConfigs: [[
                        url: 'https://github.com/Safi-Ahmed-Shariff/AutoML-DevOps.git'
                    ]]
                ])
            }
        }

        stage('Build Docker Image') {
            steps {
                bat 'docker build -t model-trainer ./docker'
            }
        }

        stage('Find Latest CSV') {
            steps {
                script {
                    def latestCsv = powershell(
                        script: '''
                        $files = Get-ChildItem -Path "train-uploader/uploads" -Filter *.csv | Sort-Object LastWriteTime -Descending
                        if ($files.Count -eq 0) {
                            Write-Error "❌ No CSV files found in train-uploader/uploads"
                            exit 1
                        }
                        $files[0].Name
                        ''',
                        returnStdout: true
                    ).trim()

                    env.LATEST_CSV = latestCsv
                    echo "✅ Latest CSV file detected: ${env.LATEST_CSV}"
                }
            }
        }

        stage('Run Model Trainer') {
            steps {
                bat """
                docker run --rm ^
                -v "%CD%\\train-uploader\\uploads:/app/uploads" ^
                model-trainer ^
                python train.py "/app/uploads/%LATEST_CSV%"
                """
            }
        }

        stage('Upload model to S3 bucket') {
            steps {
                bat 'python upload_to_s3.py'
            }
        }
    }
}
