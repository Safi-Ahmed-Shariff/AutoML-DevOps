pipeline {
    agent any

    environment {
        AWS_ACCESS_KEY_ID = credentials('aws-access-key-id')     // Jenkins credential ID
        AWS_SECRET_ACCESS_KEY = credentials('aws-secret-key-id') // Jenkins credential ID
        AWS_DEFAULT_REGION = 'ap-south-1'
    }

    stages {
        stage('Checkout') {
            steps {
                checkout([$class: 'GitSCM',
                    branches: [[name: '*/main']],
                    userRemoteConfigs: [[
                        url: 'https://github.com/Safi-Ahmed-Shariff/AutoML-DevOps.git'
                    ]]
                ])
            }
        }

        stage('Build Docker Image') {
            steps {
                bat 'docker build -t model-trainer ./docker'
            }
        }

        stage('Run Model Trainer') {
            steps {
                script {
                    // Get the latest CSV file (sorted by date descending)
                    def csvOutput = bat(
                        script: 'for /f "delims=" %f in (\'dir /b /o:-d train-uploader\\uploads\\*.csv\') do @echo %f & goto :eof',
                        returnStdout: true
                    ).trim()

                    if (csvOutput == "") {
                        error('❌ No CSV file found in train-uploader/uploads/')
                    }

                    def latestCsv = csvOutput
                    echo "✅ Latest CSV file detected: ${latestCsv}"

                    // Run the Docker container with volume mount
                    bat """
                        docker run --rm ^
                        -v "%CD%\\train-uploader\\uploads:/app/uploads" ^
                        model-trainer ^
                        python train.py "/app/uploads/${latestCsv}"
                    """
                }
            }
        }

        stage('Upload model to S3 bucket') {
            steps {
                bat 'python upload_to_s3.py'
            }
        }
    }
}
